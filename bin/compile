#!/bin/sh

echo "ARGS to: $0 $*"
BUILD_DIR=$1
CACHE_DIR=$2

function mktmpdir() {
  dir=$(mktemp -t node-$1-XXXX)
  rm -rf $dir
  mkdir -p $dir
  echo $dir
}

function indent() {
  c='s/^/       /'
  case $(uname) in
    Darwin) sed -l "$c";;
    *)      sed -u "$c";;
  esac
}

METEOR_BUILD_DIR="$BUILD_DIR/.meteor/heroku_build"
mkdir -p "$HOME"


cd $BUILD_DIR
echo "Installing meteor" | indent

# Using different folder to prevent install script form deleting packages file
VENDORED_METEOR="$(mktmpdir meteor)"
curl https://install.meteor.com | HOME="$VENDORED_METEOR" /bin/sh | indent
echo "Meteor installed" | indent


echo "Building meteor bundle" | indent
HOME="$VENDORED_METEOR" "$VENDORED_METEOR"/.meteor/meteor bundle "$CACHE_DIR"/bundle.tar.gz 2>&1 | indent

mkdir -p "$METEOR_BUILD_DIR"/app
tar -zxf "$CACHE_DIR"/bundle.tar.gz --strip-components 1 -C "$METEOR_BUILD_DIR"/app
rm "$CACHE_DIR"/bundle.tar.gz


# vendor node into the slug
PATH="$METEOR_BUILD_DIR/bin:$PATH"
echo "-----> Vendoring node into slug"
mkdir -p "$METEOR_BUILD_DIR/bin"
